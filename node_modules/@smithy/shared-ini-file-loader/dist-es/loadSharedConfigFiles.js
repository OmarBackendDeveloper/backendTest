import { join } from "path";
import { getConfigData } from "@smithy/shared-ini-file-loader/dist-cjs/getConfigData";
import { getConfigFilepath } from "@smithy/shared-ini-file-loader/dist-cjs/getConfigFilepath";
import { getCredentialsFilepath } from "@smithy/shared-ini-file-loader/dist-cjs/getCredentialsFilepath";
import { getHomeDir } from "@smithy/shared-ini-file-loader/dist-cjs/getHomeDir";
import { parseIni } from "@smithy/shared-ini-file-loader/dist-cjs/parseIni";
import { slurpFile } from "@smithy/shared-ini-file-loader/dist-cjs/slurpFile";
const swallowError = () => ({});
export const CONFIG_PREFIX_SEPARATOR = ".";
export const loadSharedConfigFiles = async (init = {}) => {
    const { filepath = getCredentialsFilepath(), configFilepath = getConfigFilepath() } = init;
    const homeDir = getHomeDir();
    const relativeHomeDirPrefix = "~/";
    let resolvedFilepath = filepath;
    if (filepath.startsWith(relativeHomeDirPrefix)) {
        resolvedFilepath = join(homeDir, filepath.slice(2));
    }
    let resolvedConfigFilepath = configFilepath;
    if (configFilepath.startsWith(relativeHomeDirPrefix)) {
        resolvedConfigFilepath = join(homeDir, configFilepath.slice(2));
    }
    const parsedFiles = await Promise.all([
        slurpFile(resolvedConfigFilepath, {
            ignoreCache: init.ignoreCache,
        })
            .then(parseIni)
            .then(getConfigData)
            .catch(swallowError),
        slurpFile(resolvedFilepath, {
            ignoreCache: init.ignoreCache,
        })
            .then(parseIni)
            .catch(swallowError),
    ]);
    return {
        configFile: parsedFiles[0],
        credentialsFile: parsedFiles[1],
    };
};
